# ç¬¬ä¸€é˜¶æ®µï¼šæ‰“é€š YAML ä¸ Go ä»£ç çš„â€œæ¬¡å…ƒå£â€

åœ¨ K8s ä¸­ï¼Œæ‰€æœ‰çš„èµ„æºï¼ˆPodã€Deploymentã€ä»¥åŠä½ è‡ªå·±å®šä¹‰çš„ CRDï¼‰åœ¨ä»£ç é‡Œéƒ½æ˜¯ä¸€ä¸ª **Structï¼ˆç»“æ„ä½“ï¼‰**ã€‚

### æ ¸å¿ƒåŒ…çš„èŒè´£åˆ†å·¥

ä½ éœ€è¦å…³æ³¨çš„åŒ…åªæœ‰è¿™ä¸¤ä¸ªï¼š

- **`k8s.io/apimachinery/pkg/apis/meta/v1` (é€šå¸¸åˆ«åä¸º `metav1`)**ï¼š
    
    - **èŒè´£**ï¼šå®šä¹‰â€œå…ƒæ•°æ®â€ã€‚ä¸ç®¡ä½ æ˜¯ Pod è¿˜æ˜¯è‡ªå®šä¹‰èµ„æºï¼Œåªè¦åœ¨ K8s é‡Œï¼Œå°±å¿…é¡»æœ‰åå­—ã€æ ‡ç­¾è¿™äº›é€šç”¨çš„å±æ€§ã€‚
        
- **`k8s.io/api/...` (å¦‚ `core/v1` æˆ– `apps/v1`)**ï¼š
    
    - **èŒè´£**ï¼šå®šä¹‰â€œå…·ä½“é›¶ä»¶â€ã€‚æ¯”å¦‚ Pod çš„å®¹å™¨é•œåƒã€ç«¯å£å·ç­‰å…·ä½“ä¸šåŠ¡å­—æ®µã€‚

### K8s å¯¹è±¡çš„â€œæ ‡å‡†å››éƒ¨æ›²â€ 

å‡ ä¹æ‰€æœ‰çš„ K8s Go ç»“æ„ä½“éƒ½ç”±è¿™å››ä¸ªéƒ¨åˆ†ç»„æˆã€‚è¯·çœ‹è¿™ä¸ªå¯¹ç…§è¡¨ï¼Œè¿™æ˜¯æœ€æ ¸å¿ƒçš„æ˜ å°„å…³ç³»ï¼š

| **YAML å­—æ®µ**           | **Go ç»“æ„ä½“ä¸­çš„å­—æ®µ**   | **ç±»å‹**              | **è¯´æ˜**                              |
| --------------------- | ---------------- | ------------------- | ----------------------------------- |
| `apiVersion` / `kind` | `TypeMeta`       | `metav1.TypeMeta`   | å®šä¹‰è¿™æ˜¯ä»€ä¹ˆèµ„æºï¼ˆå¦‚ v1 ç‰ˆçš„ Podï¼‰ã€‚              |
| `metadata`            | **`ObjectMeta`** | `metav1.ObjectMeta` | **é‡ç‚¹ï¼š** åŒ…å« Name, Namespace, Labelsã€‚ |
| `spec`                | `Spec`           | è‡ªå®šä¹‰ç»“æ„ä½“              | **é‡ç‚¹ï¼š** ç”¨æˆ·çš„â€œæœŸæœ›â€ã€‚ä½ æƒ³è¦ä»€ä¹ˆæ ·ï¼Ÿ             |
| `status`              | `Status`         | è‡ªå®šä¹‰ç»“æ„ä½“              | **é‡ç‚¹ï¼š** é›†ç¾¤çš„â€œç°å®â€ã€‚ç°åœ¨å˜æˆäº†ä»€ä¹ˆæ ·ï¼Ÿ           |
### æ·±åº¦æ‹†è§£ï¼šObjectMetaï¼ˆä½ æœ€å¸¸æ“ä½œçš„éƒ¨åˆ†ï¼‰

å½“ä½ åˆ›å»ºä¸€ä¸ª Operator æ—¶ï¼Œä½ ç»å¸¸éœ€è¦è¯»å–æˆ–ä¿®æ”¹ `metadata`ã€‚åœ¨ Go ä»£ç é‡Œï¼Œå®ƒå¯¹åº” `metav1.ObjectMeta` ç»“æ„ä½“ã€‚

**æœ€å¸¸ç”¨çš„å­—æ®µï¼š**

- **`Name`**: èµ„æºçš„åç§°ã€‚
    
- **`Namespace`**: æ‰€å±å‘½åç©ºé—´ã€‚
    
- **`Labels`**: ä¸€ä¸ª `map[string]string`ï¼Œç”¨äºè¿‡æ»¤å’Œå…³è”èµ„æºã€‚
    
- **`Annotations`**: å­˜å‚¨é¢å¤–ä¿¡æ¯ï¼ˆé€šå¸¸ä¸ä½œä¸ºæœç´¢æ¡ä»¶ï¼‰ã€‚
    
- **`OwnerReferences`**: ä¸€ä¸ªæ•°ç»„ã€‚**Operator æå…¶å…³é”®çš„å­—æ®µ**ï¼Œç”¨æ¥å®ç°â€œçˆ¶å­ç»‘å®šâ€ã€‚åˆ é™¤äº†çˆ¶èµ„æºï¼ŒK8s ä¼šæ ¹æ®è¿™ä¸ªå­—æ®µè‡ªåŠ¨åˆ é™¤å…³è”çš„å­èµ„æºã€‚
# ç¬¬äºŒé˜¶æ®µï¼š**ç©è½¬â€œå¢åˆ æ”¹æŸ¥â€ï¼ˆCRUDï¼‰**

åœ¨ç¬¬ä¸€é˜¶æ®µä½ å­¦ä¼šäº†å¦‚ä½•å®šä¹‰èµ„æºï¼Œç°åœ¨ä½ è¦å­¦ä¹ å¦‚ä½•é€šè¿‡ä»£ç å»â€œæ“æ§â€å®ƒä»¬ã€‚è¿™æ˜¯ Operator é€»è¾‘ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚åœ¨ Kubebuilder ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨ `sigs.k8s.io/controller-runtime/pkg/client` è¿™ä¸ªåŒ…æä¾›çš„ **Client æ¥å£**ã€‚

### æ ¸å¿ƒå·¥å…·ï¼š`client.Client`

ä¸ºä»€ä¹ˆä¸ç”¨ `client-go` çš„åŸç”Ÿæ¥å£ï¼Ÿ å› ä¸º Kubebuilder æä¾›çš„è¿™ä¸ª `Client` åšäº†æå¼ºçš„å°è£…ï¼š

- **è¯»æ“ä½œï¼š** é»˜è®¤ä»æœ¬åœ°ç¼“å­˜ï¼ˆInformerï¼‰è¯»ï¼Œé€Ÿåº¦æå¿«ã€‚å½“ä½ æ‰§è¡Œ `Get` æˆ– `List` æ—¶ï¼Œå®ƒé»˜è®¤æ˜¯ä»æœ¬åœ°å†…å­˜ï¼ˆInformer ç»´æŠ¤çš„ç¼“å­˜ï¼‰è¯»å–ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½å†²å‘ API Serverï¼Œè¿™æå¤§å‡è½»äº†é›†ç¾¤å‹åŠ›ã€‚
    
- **å†™æ“ä½œï¼š** ç›´æ¥å†™å‘ API Serverã€‚
    
- **æ™ºèƒ½ï¼š** å®ƒèƒ½æ ¹æ®ä½ ä¼ å…¥çš„ç»“æ„ä½“è‡ªåŠ¨åˆ¤æ–­å»è°ƒå“ªä¸ª API è·¯å¾„ã€‚
### è·å–èµ„æºï¼š`Get` (æŸ¥å•ä¸ª)

è¿™æ˜¯ä½ å†™ `Reconcile` å‡½æ•°çš„ç¬¬ä¸€æ­¥ï¼šå…ˆæ‹¿åˆ°ä½ è¦å¤„ç†çš„é‚£ä¸ªå¯¹è±¡ã€‚

- **å…³é”®ç‚¹ï¼š** éœ€è¦ `types.NamespacedName`ï¼ˆåŒ…å« Name å’Œ Namespaceï¼‰ã€‚
    
- **å¿…é¡»å…³æ³¨ï¼š** **é”™è¯¯å¤„ç†**ã€‚å¦‚æœèµ„æºä¸å­˜åœ¨ï¼ŒAPI ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œä½ éœ€è¦åˆ¤æ–­å®ƒæ˜¯â€œçœŸå‡ºé”™äº†â€è¿˜æ˜¯â€œèµ„æºè¢«åˆ é™¤äº†â€ã€‚

```go
import (
    "context"
    "sigs.k8s.io/controller-runtime/pkg/client"
    corev1 "k8s.io/api/core/v1" // æ ¸å¿ƒèµ„æºåŒ…
    "k8s.io/apimachinery/pkg/types" // æ–°åŒ…ï¼šå®šä¹‰ K8s åŸºç¡€ç±»å‹ï¼Œå¦‚ NamespacedName
    "k8s.io/apimachinery/pkg/api/errors" // é”™è¯¯è¯†åˆ«ã€‚ä¸“é—¨ç”¨æ¥åˆ¤æ–­â€œè¿™ä¸ªæŠ¥é”™æ˜¯ä¸æ˜¯å› ä¸ºèµ„æºæ²¡æ‰¾åˆ°ï¼Ÿâ€æˆ–è€…æ˜¯â€œæ˜¯ä¸æ˜¯æƒé™ä¸è¶³ï¼Ÿâ€ã€‚
)

func (r *MyReconciler) DemoGet(ctx context.Context) {
    // 1. å®šä¹‰ä¸€ä¸ª NamespacedNameï¼Œå®ƒæ˜¯ Get æ–¹æ³•çš„â€œåœ°å€å¡â€
    // ä¸ºä»€ä¹ˆï¼šK8s é‡Œçš„èµ„æºæ˜¯é€šè¿‡ å‘½åç©ºé—´+åå­— å”¯ä¸€ç¡®å®šçš„
    objKey := types.NamespacedName{
        Namespace: "default",
        Name:      "my-pod",
    }

    // 2. å£°æ˜ä¸€ä¸ªç»“æ„ä½“å˜é‡æ¥æ¥æ”¶ç»“æœ
    // ä¸ºä»€ä¹ˆï¼šGet æ–¹æ³•éœ€è¦ä¸€ä¸ªâ€œå®¹å™¨â€æ¥å­˜æ”¾ä»é›†ç¾¤æ‹¿å›æ¥çš„æ•°æ®
    pod := &corev1.Pod{}
	
    // 3. æ‰§è¡Œ Get
    // å‚æ•°è¯´æ˜ï¼š
    // - ctx: æ§åˆ¶è¶…æ—¶å’Œå–æ¶ˆ
    // - objKey: å‘Šè¯‰å®¢æˆ·ç«¯æŸ¥å“ªä¸ª
    // - pod: ä¼ å…¥æŒ‡é’ˆï¼ŒæŸ¥è¯¢ç»“æœä¼šå¡«å……åˆ°è¿™ä¸ªå˜é‡é‡Œ
    err := r.Get(ctx, objKey, pod)
    if errors.IsNotFound(err) { // èµ„æºè¢«åˆ é™¤äº†ï¼Œè¿™æ—¶å€™ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦æŠ¥ errorï¼Œå¦åˆ™ä¼šè§¦å‘æ— æ•ˆé‡è¯• 
    return ctrl.Result{}, nil 
    } // å…¶ä»–è¯»å–é”™è¯¯ï¼ˆå¦‚ç½‘ç»œé—®é¢˜ã€RBAC æƒé™ä¸è¶³ï¼‰ï¼Œéœ€è¦è¿”å› error è®© K8s é‡è¯• 
    return ctrl.Result{}, err
}
    if err != nil {
        // è¿”å›é”™è¯¯çš„å¤„ç†ï¼šå¦‚æœæŠ¥é”™æ˜¯å› ä¸ºâ€œæ²¡æ‰¾åˆ°â€ï¼Œé€šå¸¸ä»£è¡¨èµ„æºè¢«åˆ äº†
        return
    }
}
```
### è·å–åˆ—è¡¨ï¼š`List` (æŸ¥ä¸€æ‰¹)

åœºæ™¯ï¼šä½ æƒ³çŸ¥é“å½“å‰å‘½åç©ºé—´ä¸‹æœ‰å¤šå°‘ä¸ª Podã€‚

- **å…³é”®ç‚¹ï¼š** ä½¿ç”¨ `client.InNamespace` æˆ– `client.MatchingLabels` è¿›è¡Œè¿‡æ»¤ã€‚

```go
func (r *MyReconciler) DemoList(ctx context.Context) {
    // 1. å£°æ˜ä¸€ä¸ª List ç±»å‹çš„â€œå®¹å™¨â€
    podList := &corev1.PodList{}

    // 2. è®¾å®šè¿‡æ»¤æ¡ä»¶ï¼ˆå¯é€‰ï¼‰
    // ç›®çš„ï¼šå¦‚æœä¸åŠ æ¡ä»¶ï¼Œä¼šæŠŠæ•´ä¸ª Namespace ä¸‹çš„æ‰€æœ‰ Pod éƒ½æå‡ºæ¥
    listOpts := []client.ListOption{
        client.InNamespace("default"),
        client.MatchingLabels{"app": "nginx"}, // åªæ‰¾å¸¦ app=nginx æ ‡ç­¾çš„
    }

    // 3. æ‰§è¡Œ List
    err := r.List(ctx, podList, listOpts...)
    
    // podList.Items å°±æ˜¯æœ€ç»ˆçš„ Pod æ•°ç»„
}
```
### åˆ›å»ºèµ„æºï¼š`Create` (å¢)

- **å…³é”®ç‚¹ï¼š** å¿…é¡»å…ˆæ‰‹åŠ¨å¡«å¥½ `ObjectMeta`ï¼ˆåå­—å’Œç©ºé—´ï¼‰ã€‚
    
- **é‡è¦ç»†èŠ‚ï¼š** åœ¨ç¬¬äºŒé˜¶æ®µï¼Œå¦‚æœä½ åˆ›å»ºçš„æ˜¯å­èµ„æºï¼ˆæ¯”å¦‚ä½ çš„ CR åˆ›å»ºäº†ä¸€ä¸ª Deploymentï¼‰ï¼Œ**å¿…é¡»å»ºç«‹çˆ¶å­å…³ç³»**ï¼ˆè¿™å±äºç¬¬äº”é˜¶æ®µæå‰å‰§é€ï¼Œä½†è¿™é‡Œå¿…é¡»æï¼Œå¦åˆ™åˆ ä¸æ‰ï¼‰ã€‚

```go
func (r *MyReconciler) DemoCreate(ctx context.Context) {
    newPod := &corev1.Pod{
        // è®°å¾—ç¬¬ä¸€é˜¶æ®µå­¦çš„å—ï¼Ÿå¿…é¡»å¡« TypeMeta å’Œ ObjectMeta
        ObjectMeta: metav1.ObjectMeta{
            Name:      "new-pod",
            Namespace: "default",
        },
        Spec: corev1.PodSpec{
            Containers: []corev1.Container{
                {Name: "nginx", Image: "nginx"},
            },
        },
    }

    // æ‰§è¡Œåˆ›å»º
    // è¿”å›å€¼ï¼šerr å¦‚æœä¸ä¸ºç©ºï¼Œå¯èƒ½æ˜¯æƒé™ä¸è¶³æˆ–åå­—å†²çª
    err := r.Create(ctx, newPod)
}
```
### ä¿®æ”¹èµ„æºï¼š`Update` ä¸ `Status().Update()` (æ”¹)

**è¿™æ˜¯åˆå­¦è€…æœ€å®¹æ˜“æ‰å‘çš„åœ°æ–¹ï¼**

- **æ™®é€š `Update`ï¼š** ä¿®æ”¹ `Spec`ã€`Labels`ã€`Annotations` ç­‰ã€‚
    
- **`Status().Update()`ï¼š** **ä¸“é—¨ä¿®æ”¹ `Status` éƒ¨åˆ†**ã€‚K8s å»ºè®®å°† Spec å’Œ Status åˆ†å¼€æ›´æ–°ï¼Œå› ä¸º Status æ˜¯ç”±æ§åˆ¶å™¨è®¡ç®—å‡ºæ¥çš„ï¼Œä¸æ˜¯ç”¨æˆ·å¡«å†™çš„ã€‚

```go
// 1. ä¿®æ”¹ Spec (ç”¨æˆ·æœŸæœ›)
instance.Spec.Replicas = 5
err := r.Update(ctx, instance)

// 2. ä¿®æ”¹ Status (å½“å‰ç°å®) â€”â€” å¿…é¡»ç”¨ .Status() 
instance.Status.ReadyReplicas = 3
err := r.Status().Update(ctx, instance)
```
### åˆ é™¤èµ„æºï¼š`Delete` (åˆ )

ç›¸å¯¹ç®€å•ï¼Œç›´æ¥ä¼ å…¥å¯¹è±¡å³å¯ã€‚

```go
err := r.Delete(ctx, instance)
```

### ç¬¬äºŒé˜¶æ®µçš„é«˜çº§â€œæ€§ä»·æ¯”â€çŸ¥è¯†ç‚¹

#### å†²çªå¤„ç†ï¼š`RetryOnConflict`

å½“ä½ æ‰§è¡Œ `Update` æ—¶ï¼Œå¦‚æœæ­¤æ—¶æœ‰åˆ«äººä¹Ÿåœ¨æ”¹è¿™ä¸ªèµ„æºï¼ŒK8s ä¼šæŠ¥ `Conflict` é”™è¯¯å¯¼è‡´æ›´æ–°å¤±è´¥ã€‚ **æœ€å¿«åº”å¯¹æ–¹æ¡ˆï¼š** ä½¿ç”¨ `k8s.io/client-go/util/retry` åŒ…ã€‚

```go
import "k8s.io/client-go/util/retry"

err := retry.RetryOnConflict(retry.DefaultRetry, func() error {
    // 1. é‡æ–° Get ä¸€æ¬¡æœ€æ–°æ•°æ®ï¼ˆå¿…åšï¼ï¼‰
    latest := &webv1.MyWebApp{}
    if err := r.Get(ctx, req.NamespacedName, latest); err != nil {
        return err
    }
    // 2. åšä½ çš„ä¿®æ”¹
    latest.Spec.Replicas = 10
    // 3. è¿”å› Update ç»“æœ
    return r.Update(ctx, latest)
})
```

#### æ‰€æœ‰çš„è°ƒç”¨éƒ½è¦ä¼  `ctx` (Context)

ä½ ä¼šå‘ç°æ¯ä¸ªæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯ `ctx`ã€‚è¿™æ˜¯ä¸ºäº†æ§åˆ¶è¶…æ—¶å’Œå–æ¶ˆã€‚åœ¨ `Reconcile` å‡½æ•°å¼€å¤´ä¼ å…¥çš„é‚£ä¸ª `ctx` ç›´æ¥é€ä¼ ç»™ client å³å¯ã€‚

#### æ°¸è¿œä¼ é€’æŒ‡é’ˆ

ä¸ç®¡æ˜¯ `Get` è¿˜æ˜¯ `Update`ï¼Œä¼ å…¥çš„èµ„æºå¯¹è±¡å¿…é¡»æ˜¯**æŒ‡é’ˆ**ï¼ˆä¾‹å¦‚ `&instance`ï¼‰ï¼Œå› ä¸º client éœ€è¦ä¿®æ”¹è¯¥å¯¹è±¡çš„å†…å®¹ã€‚

**é›¶å€¼å¤„ç†**ï¼š åœ¨ä¿®æ”¹èµ„æºå¹¶ `Update` æ—¶ï¼Œç¡®ä¿ä½ æ²¡æœ‰æ— æ„ä¸­æŠŠæŸäº›å­—æ®µæ”¹æˆäº†é›¶å€¼ï¼ˆå¦‚æŠŠå‰¯æœ¬æ•°æ”¹æˆäº† 0ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´é›†ç¾¤çŠ¶æ€å‘ç”Ÿéé¢„æœŸçš„å‰§çƒˆæ³¢åŠ¨ã€‚

#### æ·»åŠ æƒé™

 **åˆ«å¿˜äº† RBAC æƒé™**ï¼š ä½ åœ¨ä»£ç é‡Œå†™äº† `r.Create(pod)`ï¼Œä½†å¦‚æœä½ æ²¡åœ¨ `controller.go` çš„æ³¨é‡Šé‡ŒåŠ ä¸Š `// +kubebuilder:rbac:groups=core,resources=pods,verbs=create`ï¼Œä½ çš„ Operator è¿è¡Œèµ·æ¥å°±ä¼šæŠ¥ `Forbidden`ã€‚

#### æ•°æ®è¯»å–é€»è¾‘

**è¯»æ•°æ®é»˜è®¤æ˜¯â€œè¿‡æ—¶çš„â€**ï¼š è®°ä½ï¼Œ`r.Get` è¯»çš„æ˜¯ **Cache**ï¼ˆå†…å­˜ç¼“å­˜ï¼‰ã€‚å¦‚æœä½ åˆšåˆš `Create` äº†ä¸€ä¸ª Podï¼Œä¸‹ä¸€è¡Œç«‹å³ `Get`ï¼Œå¯èƒ½æ‹¿ä¸åˆ°ã€‚è¿™æ˜¯**åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœ€ç»ˆä¸€è‡´æ€§**ã€‚ä¸è¦ä¸ºæ­¤å†™æ­»å¾ªç¯ç­‰å¾…ï¼Œè€Œè¦ä¾é ä¸‹ä¸€æ¬¡ `Reconcile`ã€‚
# ç¬¬ä¸‰é˜¶æ®µï¼šæ§åˆ¶â€œå¤§è„‘â€â€”â€”æ·±åº¦ç†è§£ Reconcileï¼ˆè°ƒè§£ï¼‰å¾ªç¯ä¸å¹‚ç­‰æ€§è®¾è®¡

### æ ¸å¿ƒæ¦‚å¿µï¼šä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼ˆIdempotencyï¼‰ï¼Ÿ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œä¼šæŠ–åŠ¨ï¼Œè¿›ç¨‹ä¼šå´©æºƒã€‚`Reconcile` å‡½æ•°å¯èƒ½ä¼šå› ä¸ºå„ç§åŸå› è¢«åå¤è°ƒç”¨ï¼ˆæ¯”å¦‚ä¸€åˆ†é’Ÿè°ƒç”¨ 100 æ¬¡ï¼‰ã€‚ **å¹‚ç­‰æ€§è¦æ±‚ï¼š** æ— è®º `Reconcile` è¢«è°ƒç”¨ 1 æ¬¡è¿˜æ˜¯ 100 æ¬¡ï¼Œæœ€ç»ˆå¯¹é›†ç¾¤äº§ç”Ÿçš„ç»“æœå¿…é¡»æ˜¯ä¸€æ ·çš„ã€‚

**å¤§è„‘çš„é€»è¾‘å…¬å¼ï¼š** `æœŸæœ›çŠ¶æ€ (Spec)` - `å®é™…çŠ¶æ€ (Actual)` = `åŠ¨ä½œ (Action)`ã€‚

### æ ¸å¿ƒåŒ…ä»‹ç»

- **`sigs.k8s.io/controller-runtime/pkg/reconcile`**
    
    - **ä½œç”¨**ï¼šå®šä¹‰äº†è°ƒè§£å¾ªç¯çš„è¾“å…¥ï¼ˆRequestï¼‰å’Œè¾“å‡ºï¼ˆResultï¼‰ã€‚
        
    - **æ ¸å¿ƒç»“æ„**ï¼š`Request` ä»…åŒ…å«èµ„æºçš„åç§°å’Œå‘½åç©ºé—´ï¼›`Result` å†³å®šäº†ä¸‹ä¸€æ¬¡è°ƒè§£ä»€ä¹ˆæ—¶å€™å‘ç”Ÿã€‚
        
- **`sigs.k8s.io/controller-runtime/pkg/log`**
    
    - **ä½œç”¨**ï¼šæä¾›ç»“æ„åŒ–æ—¥å¿—ï¼ˆåŸºäº `zap`ï¼‰ã€‚
        
    - **é‡è¦æ€§**ï¼šåœ¨ Operator ä¸­ä¸è¦ä½¿ç”¨ `fmt.Println`ï¼Œå› ä¸ºç»“æ„åŒ–æ—¥å¿—å¯ä»¥è‡ªåŠ¨å¸¦ä¸Šæ§åˆ¶å™¨åç§°å’Œè¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œæ–¹ä¾¿æ’æŸ¥å¤§è§„æ¨¡é›†ç¾¤ä¸­çš„é—®é¢˜ã€‚
        
- **`reflect` (Go æ ‡å‡†åº“)**
    
    - **ä½œç”¨**ï¼šç”¨äºæ·±åº¦æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ã€‚
        
    - **åœºæ™¯**ï¼šåˆ¤æ–­â€œç°åœ¨çš„ Deployment é…ç½®â€æ˜¯å¦çœŸçš„éœ€è¦æ›´æ–°ï¼Œé¿å…æ— æ•ˆçš„ API è°ƒç”¨ã€‚
### æœ€ä½³å®è·µä»£ç æ¼”ç¤ºï¼šä¸€ä¸ªå®Œæ•´çš„è°ƒè§£é€»è¾‘

æˆ‘ä»¬ä»¥ä¸€ä¸ªç®¡ç† `Deployment` çš„è‡ªå®šä¹‰èµ„æºä¸ºä¾‹ã€‚è¿™æ®µä»£ç å±•ç¤ºäº†å¦‚ä½•å¤„ç†ï¼š**æ£€æµ‹ -> åˆ›å»º -> æ¯”å¯¹è§„æ ¼ -> æ›´æ–°çŠ¶æ€**ã€‚

```go
import (
	"context"
	"reflect"
	"time"

	appsv1 "k8s.io/api/apps/v1"
	corev1 "k8s.io/api/core/v1"
	"k8s.io/apimachinery/pkg/api/errors"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"sigs.k8s.io/controller-runtime/pkg/client"
	"sigs.k8s.io/controller-runtime/pkg/log"
	"sigs.k8s.io/controller-runtime/pkg/reconcile"
)

// Reconcile æ˜¯ Operator çš„çµé­‚ï¼šå®ƒè§‚å¯Ÿç°çŠ¶ï¼Œå¹¶å°è¯•å‘æœŸæœ›çŠ¶æ€é æ‹¢
func (r *MyReconciler) Reconcile(ctx context.Context, req reconcile.Request) (reconcile.Result, error) {
	// 1. åˆå§‹åŒ–ç»“æ„åŒ–æ—¥å¿—
	// ç›®çš„ï¼šè®©æ—¥å¿—è‡ªåŠ¨å¸¦ä¸Šæ­£åœ¨å¤„ç†çš„èµ„æºåç§° [Name/Namespace]
	logger := log.FromContext(ctx)

	// 2. è·å–æœŸæœ›çŠ¶æ€ (è·å–ä½ çš„è‡ªå®šä¹‰èµ„æº CR)
	var myApp webv1.MyWebApp
	if err := r.Get(ctx, req.NamespacedName, &myApp); err != nil {
		if errors.IsNotFound(err) {
			// ç›®çš„ï¼šå¤„ç†èµ„æºè¢«åˆ é™¤çš„æƒ…å†µ
			// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜ CR è¢«åˆ é™¤äº†ï¼Œæ­¤æ—¶å­èµ„æºï¼ˆè®¾ç½®äº† OwnerReference çš„ï¼‰ä¼šè¢« K8s è‡ªåŠ¨æ¸…ç†
			return reconcile.Result{}, nil
		}
		return reconcile.Result{}, err
	}

	// 3. è§‚å¯Ÿå®é™…çŠ¶æ€ï¼šæŸ¥æ‰¾é›†ç¾¤ä¸­æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„ Deployment
	foundDeployment := &appsv1.Deployment{}
	err := r.Get(ctx, client.ObjectKey{Name: myApp.Name, Namespace: myApp.Namespace}, foundDeployment)

	// é€»è¾‘åˆ†æ”¯ Aï¼šå¦‚æœ Deployment ä¸å­˜åœ¨ -> åˆ›å»ºå®ƒ
	if err != nil && errors.IsNotFound(err) {
		// å®šä¹‰ä¸€ä¸ªæ–°çš„ Deployment
		dep := r.deploymentForMyApp(&myApp)
		logger.Info("æ­£åœ¨åˆ›å»ºæ–°çš„ Deployment", "Deployment.Namespace", dep.Namespace, "Deployment.Name", dep.Name)
		
		if err := r.Create(ctx, dep); err != nil {
			logger.Error(err, "åˆ›å»º Deployment å¤±è´¥")
			return reconcile.Result{}, err
		}
		// åˆ›å»ºæˆåŠŸåï¼Œé€šå¸¸å»ºè®® Requeueï¼Œä»¥ä¾¿è¿›å…¥ä¸‹ä¸€è½®æ£€æŸ¥çŠ¶æ€
		return reconcile.Result{Requeue: true}, nil
	} else if err != nil {
		return reconcile.Result{}, err
	}

	// é€»è¾‘åˆ†æ”¯ Bï¼šå¦‚æœ Deployment å·²å­˜åœ¨ -> æ£€æŸ¥è§„æ ¼æ˜¯å¦ä¸€è‡´ (å¹‚ç­‰æ€§æ ¸å¿ƒ)
	// ç›®çš„ï¼šå¦‚æœç”¨æˆ·ä¿®æ”¹äº† CR çš„é•œåƒï¼Œæˆ‘ä»¬å¿…é¡»åŒæ­¥æ›´æ–° Deployment
	expectedSize := myApp.Spec.Size
	if *foundDeployment.Spec.Replicas != expectedSize {
		logger.Info("å‰¯æœ¬æ•°ä¸ä¸€è‡´ï¼Œæ­£åœ¨æ›´æ–°", "å½“å‰", *foundDeployment.Spec.Replicas, "æœŸæœ›", expectedSize)
		foundDeployment.Spec.Replicas = &expectedSize
		
		if err := r.Update(ctx, foundDeployment); err != nil {
			return reconcile.Result{}, err
		}
		// æ›´æ–°åç«‹å³è¿”å›ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è§¦å‘
		return reconcile.Result{}, nil
	}

	// 4. æ›´æ–° Statusï¼ˆå®é™…çŠ¶æ€åé¦ˆï¼‰
	// ç›®çš„ï¼šè®©ç”¨æˆ·é€šè¿‡ kubectl get myapp å°±èƒ½çœ‹åˆ°æœ‰å¤šå°‘ Pod çœŸæ­£è¿è¡Œäº†
	if myApp.Status.AvailableReplicas != foundDeployment.Status.AvailableReplicas {
		myApp.Status.AvailableReplicas = foundDeployment.Status.AvailableReplicas
		if err := r.Status().Update(ctx, &myApp); err != nil {
			logger.Error(err, "æ›´æ–° Status å¤±è´¥")
			return reconcile.Result{}, err
		}
	}

	// 5. å‘¨æœŸæ€§æ£€æŸ¥ (å¯é€‰)
	// ç›®çš„ï¼šå³ä½¿æ²¡æœ‰äº‹ä»¶è§¦å‘ï¼Œæˆ‘ä¹Ÿæƒ³æ¯ 1 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆé¢„é˜²æŸäº›å¤–éƒ¨å› ç´ å¯¼è‡´çš„åç§»ï¼‰
	return reconcile.Result{RequeueAfter: time.Minute}, nil
}
```
### æ·±åº¦è§£æï¼šè¿”å›å€¼ä¸å‚æ•°çš„å¥¥ç§˜

#### `reconcile.Request` ä¸ºä»€ä¹ˆåªä¼ åå­—ä¸ä¼ å¯¹è±¡ï¼Ÿ

**åŸå› ï¼š** å½“ `Reconcile` è¢«è°ƒç”¨æ—¶ï¼Œå¯¹è±¡åœ¨ç¼“å­˜ä¸­å¯èƒ½å·²ç»å˜äº†ã€‚ä¼ åå­—è¦æ±‚ä½ æ¯æ¬¡éƒ½ä» `r.Get` è·å–**æœ€æ–°**çš„å¿«ç…§ã€‚è¿™ä¿è¯äº†ä½ çš„å†³ç­–æ˜¯åŸºäºå½“å‰çœŸå®æ•°æ®çš„ï¼Œè€Œä¸æ˜¯å‡ ç§’å‰çš„è¿‡æ—¶æ•°æ®ã€‚

#### `reconcile.Result` çš„ä¸‰ç§è¿”å›å§¿åŠ¿ï¼š

1. **`Result{}, nil`**ï¼š
    
    - **å«ä¹‰**ï¼šæˆ‘åšå®Œäº†ï¼Œä¸”å¾ˆæˆåŠŸã€‚
        
    - **ç›®çš„**ï¼šåœæ­¢è°ƒè§£ã€‚ç›´åˆ°è¿™ä¸ªèµ„æºå†æ¬¡è¢«ä¿®æ”¹ï¼ˆå¦‚ç”¨æˆ·æ”¹äº† YAMLï¼‰ï¼Œæˆ‘æ‰ä¼šè¢«å†æ¬¡å«é†’ã€‚
        
2. **`Result{Requeue: true}, nil`**ï¼š
    
    - **å«ä¹‰**ï¼šæˆ‘åˆšåˆšåšäº†ä¸€ä¸ªåŠ¨ä½œï¼ˆæ¯”å¦‚åˆ›å»ºäº† Podï¼‰ï¼Œæˆ‘æƒ³ç«‹åˆ»å†æ£€æŸ¥ä¸€éã€‚
        
    - **ç›®çš„**ï¼šå¿«é€Ÿè¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ã€‚
        
3. **`Result{RequeueAfter: time.Minute}, nil`**ï¼š
    
    - **å«ä¹‰**ï¼šç°åœ¨æ²¡äº‹äº†ï¼Œä½† 1 åˆ†é’Ÿåè¯·åŠ¡å¿…å†å«é†’æˆ‘ã€‚
        
    - **ç›®çš„**ï¼šç”¨äºå¤„ç†é‚£äº›**ä¸æ˜¯ç”± K8s èµ„æºè§¦å‘**çš„å˜åŒ–ï¼ˆæ¯”å¦‚ä½ çš„ Operator æ­£åœ¨ç›‘æ§ä¸€ä¸ªå¤–éƒ¨ API æ¥å£çš„çŠ¶æ€ï¼‰ã€‚
### ç¬¬ä¸‰é˜¶æ®µæ ¸å¿ƒé¿å‘æŒ‡å—ï¼ˆé‡è¦ä¿¡æ¯ï¼‰

1. **ç¦æ­¢åœ¨å¾ªç¯ä¸­åšé•¿æ—¶é˜»å¡åŠ¨ä½œ**ï¼š `Reconcile` æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œä½†å¦‚æœä½ åœ¨é‡Œé¢ `time.Sleep(10 * time.Minute)`ï¼Œä¼šå æ­» Worker çº¿ç¨‹ï¼Œå¯¼è‡´ä½ çš„ Operator å“åº”å˜å¾—ææ…¢ã€‚
    
2. **æ°¸è¿œå‡è®¾èµ„æºå¯èƒ½ä¸å­˜åœ¨**ï¼š åœ¨æ“ä½œä»»ä½•èµ„æºå‰ï¼Œå…ˆåˆ¤æ–­ `if err != nil && errors.IsNotFound(err)`ã€‚
    
3. **é¿å…â€œå†™å†²çªâ€å¯¼è‡´çš„æ­»å¾ªç¯**ï¼š å¦‚æœä½ åœ¨ `Reconcile` é‡Œä¸åœåœ°ä¿®æ”¹ `Spec`ï¼Œè€Œ K8s å‘ç° `Spec` å˜äº†åˆå»è°ƒç”¨ `Reconcile`ï¼Œä½ å°±åˆ›é€ äº†ä¸€ä¸ªæ°¸ä¸åœæ­‡çš„â€œæ­»å¾ªç¯â€ï¼Œè¿™ä¼šæ¶ˆè€—å¤§é‡ CPUã€‚**è§„åˆ™ï¼šåªæœ‰ç”¨æˆ·èƒ½æ”¹ Specï¼ŒOperator å°½é‡åªæ”¹ Statusã€‚**
# ç¬¬å››é˜¶æ®µï¼š**æŒæ§ç”Ÿæ­»â€”â€”è¡€ç¼˜ç»‘å®šï¼ˆOwnerReferenceï¼‰ä¸å–„åå¤„ç†ï¼ˆFinalizerï¼‰**

åœ¨å‰é¢çš„é˜¶æ®µï¼Œä½ å­¦ä¼šäº†å¦‚ä½•è®© Operator â€œæ€è€ƒâ€å’Œâ€œè¡ŒåŠ¨â€ã€‚ä½†è¿™é‡Œæœ‰ä¸€ä¸ªè‡´å‘½é—®é¢˜ï¼š**å¦‚æœä½ æŠŠè‡ªå®šä¹‰èµ„æºï¼ˆCRï¼‰åˆ äº†ï¼Œå®ƒåˆ›å»ºå‡ºæ¥çš„é‚£äº› Pod å’Œ Deployment è¿˜åœ¨é›†ç¾¤é‡Œâ€œæµæµªâ€æ€ä¹ˆåŠï¼Ÿ**

### æ ¸å¿ƒåŒ…ä»‹ç»

- **`sigs.k8s.io/controller-runtime/pkg/controller/controllerutil`**
    
    - **ä½œç”¨**ï¼šè¿™æ˜¯å¤„ç†èµ„æºå…³ç³»çš„â€œå·¥å…·ç®±â€ã€‚
        
    - **æ ¸å¿ƒåŠŸèƒ½**ï¼š
        
        - `SetControllerReference`ï¼šå»ºç«‹çˆ¶å­å…³ç³»ï¼Œå®ç°è‡ªåŠ¨åƒåœ¾å›æ”¶ã€‚
            
        - `AddFinalizer` / `RemoveFinalizer`ï¼šç®¡ç†â€œç»ˆç»“å™¨â€ï¼Œå¤„ç†è‡ªå®šä¹‰åˆ é™¤é€»è¾‘ã€‚
            
- **`k8s.io/apimachinery/pkg/runtime`**
    
    - **ä½œç”¨**ï¼šå®šä¹‰äº† K8s çš„å¯¹è±¡è½¬æ¢åè®®ã€‚
        
    - **é‡è¦æ€§**ï¼šåœ¨å»ºç«‹çˆ¶å­å…³ç³»æ—¶ï¼Œä»£ç éœ€è¦çŸ¥é“å½“å‰é›†ç¾¤çš„ `Scheme`ï¼ˆæ¶æ„æ–¹æ¡ˆï¼‰ï¼Œä»¥ä¾¿ç¡®è®¤çˆ¶èµ„æºå’Œå­èµ„æºçš„ç‰ˆæœ¬æ˜¯å¦åŒ¹é…ã€‚
### æœ€ä½³å®è·µï¼šçˆ¶å­ç»‘å®šï¼ˆè‡ªåŠ¨åƒåœ¾å›æ”¶ï¼‰

**ç›®çš„**ï¼šå½“ç”¨æˆ·åˆ é™¤ `MyWebApp` æ—¶ï¼ŒKubernetes çš„ **Garbage Collector (GC)** ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶åˆ é™¤æ‰€æœ‰å…³è”çš„ Deploymentã€‚

```go
// è¿™æ˜¯ä¸€ä¸ªå†…éƒ¨è¾…åŠ©å‡½æ•°ï¼Œç”¨äºæ„å»ºå­èµ„æº
func (r *MyReconciler) deploymentForMyApp(myApp *webv1.MyWebApp) (*appsv1.Deployment, error) {
	dep := &appsv1.Deployment{
		ObjectMeta: metav1.ObjectMeta{
			Name:      myApp.Name,
			Namespace: myApp.Namespace,
		},
		Spec: appsv1.DeploymentSpec{ /* ... çœç•¥å…·ä½“é…ç½® ... */ },
	}

	// ã€æ ¸å¿ƒåŠ¨ä½œã€‘ï¼šå»ºç«‹è¡€ç¼˜å…³ç³»
	// å‚æ•°è¯´æ˜ï¼š
	// 1. myApp: çˆ¶èµ„æºï¼ˆOwnerï¼‰
	// 2. dep: å­èµ„æºï¼ˆControlledï¼‰
	// 3. r.Scheme: å‘Šè¯‰ K8s å¦‚ä½•è¯†åˆ«è¿™ä¸¤ä¸ªå¯¹è±¡çš„ç±»å‹
	// ç›®çš„ï¼šåœ¨ dep çš„ metadata ä¸­æ³¨å…¥ OwnerReference å­—æ®µ
	if err := controllerutil.SetControllerReference(myApp, dep, r.Scheme); err != nil {
		return nil, err
	}

	return dep, nil
}
```

### æœ€ä½³å®è·µï¼šç»ˆç»“å™¨ï¼ˆFinalizerï¼‰å¤„ç†é€»è¾‘

**åœºæ™¯**ï¼šå¦‚æœä½ çš„ Operator åœ¨å¤–éƒ¨ï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰åˆ›å»ºäº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ã€‚ä»…ä»…åˆ é™¤ K8s é‡Œçš„ CR æ˜¯ä¸å¤Ÿçš„ï¼Œä½ å¿…é¡»åœ¨å®ƒæ¶ˆå¤±å‰ï¼Œå…ˆè°ƒç”¨äº‘ API æŠŠè´Ÿè½½å‡è¡¡å™¨åˆ äº†ã€‚

**åŸç†**ï¼šåªè¦å¯¹è±¡ä¸­å­˜åœ¨ `finalizers` åˆ—è¡¨ï¼ŒK8s å°±ä¸å…è®¸å½»åº•åˆ é™¤å®ƒï¼Œåªä¼šç»™å®ƒæ‰“ä¸Š `DeletionTimestamp` æ ‡è®°ã€‚

```go
func (r *MyReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
	myApp := &webv1.MyWebApp{}
	if err := r.Get(ctx, req.NamespacedName, myApp); err != nil {
		return ctrl.Result{}, client.IgnoreNotFound(err)
	}

	// å®šä¹‰ä¸€ä¸ªå”¯ä¸€çš„ Finalizer åå­—ï¼ˆé€šå¸¸æ ¼å¼ä¸ºï¼šåŸŸå/åå­—ï¼‰
	myFinalizerName := "web.example.com/finalizer"

	// æ£€æŸ¥èµ„æºæ˜¯å¦æ­£åœ¨è¢«åˆ é™¤
	if myApp.ObjectMeta.DeletionTimestamp.IsZero() {
		// æƒ…å†µ Aï¼šèµ„æºè¿˜æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤
		// å¦‚æœå®ƒè¿˜æ²¡æœ‰æˆ‘ä»¬çš„ Finalizerï¼Œå°±æŠŠå®ƒåŠ ä¸Š
		if !controllerutil.ContainsFinalizer(myApp, myFinalizerName) {
			controllerutil.AddFinalizer(myApp, myFinalizerName)
			if err := r.Update(ctx, myApp); err != nil {
				return ctrl.Result{}, err
			}
		}
	} else {
		// æƒ…å†µ Bï¼šèµ„æºæ­£åœ¨è¢«åˆ é™¤ï¼ˆç”¨æˆ·ç‚¹äº†åˆ é™¤æŒ‰é’®ï¼‰
		if controllerutil.ContainsFinalizer(myApp, myFinalizerName) {
			// ã€æ‰§è¡Œè‡ªå®šä¹‰æ¸…ç†é€»è¾‘ã€‘ï¼šæ¯”å¦‚è°ƒç”¨å¤–éƒ¨ API é”€æ¯èµ„æº
			if err := r.deleteExternalResources(myApp); err != nil {
				// å¦‚æœæ¸…ç†å¤±è´¥ï¼Œç›´æ¥è¿”å›é”™è¯¯ï¼ŒK8s ä¼šé‡è¯•ï¼Œèµ„æºä¸ä¼šè¢«çœŸæ­£åˆ é™¤
				return ctrl.Result{}, err
			}

			// æ¸…ç†æˆåŠŸåï¼Œç§»é™¤ Finalizer
			// ä¸€æ—¦ Finalizer åˆ—è¡¨ä¸ºç©ºï¼ŒK8s å°±ä¼šçœŸæ­£æŠŠèµ„æºä» etcd é‡ŒæŠ¹æ‰
			controllerutil.RemoveFinalizer(myApp, myFinalizerName)
			if err := r.Update(ctx, myApp); err != nil {
				return ctrl.Result{}, err
			}
		}
		// æ­£åœ¨åˆ é™¤è¿‡ç¨‹ä¸­ï¼Œé€»è¾‘å¤„ç†å®Œåç›´æ¥è¿”å›
		return ctrl.Result{}, nil
	}

	// æ­£å¸¸çš„ Reconcile é€»è¾‘ç»§ç»­...
	return ctrl.Result{}, nil
}
```
### æ·±åº¦è§£æï¼šä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿ

#### Q: ä¸ºä»€ä¹ˆæœ‰äº† `SetControllerReference` è¿˜éœ€è¦ `Finalizer`ï¼Ÿ

- **`SetControllerReference`** åªèƒ½ç®¡ **K8s å†…éƒ¨** çš„èµ„æºï¼ˆå¦‚ï¼šåˆ äº† CR è‡ªåŠ¨åˆ  Podï¼‰ã€‚
    
- **`Finalizer`** ä¸“é—¨ç®¡ **K8s å¤–éƒ¨** çš„èµ„äº§ï¼ˆå¦‚ï¼šæ•°æ®åº“è´¦å·ã€äº‘ç«¯ LBã€ç£ç›˜å·ï¼‰ã€‚
    
#### Q: ä¸ºä»€ä¹ˆ `SetControllerReference` éœ€è¦ä¼ é€’ `r.Scheme`ï¼Ÿ

`Scheme` æ˜¯ K8s çš„â€œæˆ·å£ç™»è®°è¡¨â€ã€‚å¦‚æœä½ æƒ³è®© `MyWebApp` åš `Deployment` çš„çˆ¶äº²ï¼Œä»£ç éœ€è¦é€šè¿‡ `Scheme` æŸ¥åˆ° `MyWebApp` å±äºå“ªä¸ª `GroupVersion`ï¼ˆæ¯”å¦‚ `web.example.com/v1`ï¼‰ï¼Œè¿™æ ·ç”Ÿæˆçš„ `OwnerReference` æ‰æ˜¯åˆæ³•çš„ã€‚

#### Q: å¦‚æœ `deleteExternalResources` ä¸€ç›´å¤±è´¥ä¼šæ€æ ·ï¼Ÿ

ä½ çš„ CR ä¼šä¸€ç›´å¡åœ¨ `Terminating` çŠ¶æ€ï¼Œåˆ ä¸æ‰ã€‚è¿™è™½ç„¶ç—›è‹¦ï¼Œä½†å®ƒæ˜¯å®‰å…¨çš„â€”â€”å®ƒé˜²æ­¢äº†â€œå¯¹è±¡æ²¡äº†ï¼Œä½†äº‘ç«¯èµ„æºè¿˜åœ¨è®¡è´¹â€çš„æƒ…å†µå‘ç”Ÿã€‚
### ç¬¬å››é˜¶æ®µæ ¸å¿ƒé¿å‘æŒ‡å—ï¼ˆé‡è¦ä¿¡æ¯ï¼‰

1. **Finalizer å¿…é¡»å¹‚ç­‰**ï¼š ç”±äº `Reconcile` ä¼šå¤šæ¬¡è§¦å‘ï¼Œä½ çš„æ¸…ç†é€»è¾‘ï¼ˆå¦‚ `deleteExternalResources`ï¼‰å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡ã€‚ä¸€å®šè¦ç¡®ä¿å³ä½¿èµ„æºå·²ç»åˆ è¿‡äº†ï¼Œä»£ç ä¹Ÿä¸ä¼šæŠ¥é”™æŒ‚æ‰ã€‚
    
2. **æ›´æ–°å†²çª**ï¼š åœ¨ `AddFinalizer` æˆ– `RemoveFinalizer` æ—¶ï¼Œå¦‚æœ `r.Update` æŠ¥äº† `Conflict`ï¼Œè¯´æ˜èµ„æºåˆšå¥½è¢«åˆ«äººæ”¹äº†ã€‚**æœ€ä½³å®è·µï¼š** æ•è·å†²çªå¹¶é‡è¯•ï¼Œæˆ–è€…ç›´æ¥è¿”å›é”™è¯¯è®©æ•´ä¸ª `Reconcile` é‡æ¥ã€‚
    
3. **å¾ªç¯ä¾èµ–é™·é˜±**ï¼š åƒä¸‡ä¸è¦åœ¨ `Finalizer` é€»è¾‘é‡Œåˆå»åˆ›å»ºä¸€ä¸ªä¾èµ–äºçˆ¶èµ„æºçš„å­èµ„æºï¼Œè¿™ä¼šå¯¼è‡´ä½ çš„å¯¹è±¡æ°¸è¿œæ— æ³•è¢«åˆ é™¤ã€‚
# é€ŸæŸ¥è¡¨

| **é˜¶æ®µ**      | **æ ¸å¿ƒåŒ…**                       | **ä¸»è¦ç”¨é€”**              | **å…³é”®å‡½æ•°/ç»“æ„**                           |
| ----------- | ----------------------------- | --------------------- | ------------------------------------- |
| **1. å®šä¹‰**   | `metav1` (apimachinery)       | å®šä¹‰å…ƒæ•°æ®ï¼ˆåå­—ã€æ ‡ç­¾ã€è¡€ç¼˜ï¼‰       | `ObjectMeta`, `TypeMeta`              |
| **2. æ“æ§**   | `client` (controller-runtime) | ä¸ API Server é€šä¿¡ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰ | `Get`, `List`, `Update`, `Status()`   |
| **3. é€»è¾‘**   | `reconcile` / `log`           | å¤„ç†è§¦å‘äº‹ä»¶ã€æ§åˆ¶é‡è¯•ã€æ‰“æ—¥å¿—       | `Request`, `Result`, `FromContext`    |
| **4. ç”Ÿå‘½å‘¨æœŸ** | `controllerutil`              | å»ºç«‹çˆ¶å­å…³ç³»ã€å¤„ç†åˆ é™¤å‰åçš„æ¸…ç†      | `SetControllerReference`, `Finalizer` |

## æ ¸å¿ƒåŒ…æ·±åº¦è§£æ

### 1. `k8s.io/apimachinery/pkg/apis/meta/v1` (åˆ«å `metav1`)

- **å®ƒæ˜¯å¹²ä»€ä¹ˆçš„**ï¼šæ‰€æœ‰ K8s èµ„æºçš„â€œå…¬å…±èº«ä»½è¯â€ã€‚
    
- **é‡ç‚¹å­—æ®µ**ï¼š
    
    - `Name`, `Namespace`: èµ„æºçš„å”¯ä¸€åæ ‡ã€‚
        
    - **`OwnerReferences`**: **æå…¶é‡è¦**ã€‚è¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè®°å½•äº†â€œè°æ˜¯æˆ‘çš„çˆ¶äº²â€ã€‚è®¾ç½®äº†å®ƒï¼Œçˆ¶äº²è¢«åˆ ï¼Œå„¿å­è‡ªåŠ¨è¢« GCï¼ˆåƒåœ¾å›æ”¶ï¼‰ã€‚
        
- **ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆç”¨**ï¼šä¸ºäº†è®© K8s å¼•æ“çŸ¥é“èµ„æºä¹‹é—´çš„é€»è¾‘éš¶å±å…³ç³»ï¼Œé˜²æ­¢èµ„æºæ³„æ¼ã€‚
    
### 2. `sigs.k8s.io/controller-runtime/pkg/client`

- **å®ƒæ˜¯å¹²ä»€ä¹ˆçš„**ï¼šOperator çš„â€œæ‰‹â€ï¼Œè´Ÿè´£æ‰€æœ‰ API æ“ä½œã€‚
    
- **å…³é”®å‡½æ•°è¯¦è§£**ï¼š
    
    - **`Get(ctx, key, obj)`**:
        
        - **ä¼ å‚**ï¼š`Context`ï¼ˆè¶…æ—¶æ§åˆ¶ï¼‰ã€`NamespacedName`ï¼ˆæ‰¾è°ï¼‰ã€`å¯¹è±¡æŒ‡é’ˆ`ï¼ˆç»“æœå­˜å“ªï¼‰ã€‚
            
        - **è¿”å›**ï¼š`error`ã€‚å¦‚æœæ˜¯ `NotFound`ï¼Œè¯´æ˜èµ„æºä¸å­˜åœ¨ã€‚
            
    - **`Status().Update(ctx, obj)`**:
        
        - **ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆç”¨**ï¼šè¿™æ˜¯**æœ€ä½³å®è·µ**ã€‚Status æ˜¯å­èµ„æºï¼Œç‹¬ç«‹æ›´æ–°å®ƒä¸ä¼šå¯¼è‡´ `metadata.generation` å¢åŠ ï¼Œä»è€Œé¿å…å› ä¸ºè§¦å‘äº†ä¸å¿…è¦çš„ Spec å˜æ›´è€Œå¯¼è‡´æ­»å¾ªç¯ã€‚
            
### 3. `sigs.k8s.io/controller-runtime/pkg/reconcile`

- **å®ƒæ˜¯å¹²ä»€ä¹ˆçš„**ï¼šå®šä¹‰äº†å¤§è„‘çš„â€œå•æ¬¡æ€è€ƒä»»åŠ¡â€ã€‚
    
- **å…³é”®è¿”å›å€¼çš„å«ä¹‰**ï¼š
    
    - `Result{}, nil`: â€œæˆ‘ä»»åŠ¡å®Œæˆäº†ï¼Œä¸ç”¨å†å«æˆ‘ã€‚â€
        
    - `Result{Requeue: true}, nil`: â€œæˆ‘åˆšåšäº†ä¸ªåŠ¨ä½œï¼Œè¯·ç«‹åˆ»è®©æˆ‘å†æ£€æŸ¥ä¸€éã€‚â€ï¼ˆå¸¸ç”¨åœ¨åˆ›å»ºå®Œèµ„æºåï¼‰
        
    - `Result{RequeueAfter: 1*time.Minute}, nil`: â€œç°åœ¨æ­£å¸¸ï¼Œä½† 1 åˆ†é’Ÿåè¯·å‡†æ—¶å«é†’æˆ‘å·¡æ£€ã€‚â€
        
### 4. `sigs.k8s.io/controller-runtime/pkg/controller/controllerutil`

- **å®ƒæ˜¯å¹²ä»€ä¹ˆçš„**ï¼šå¤„ç†å¤æ‚çš„å¯¹è±¡å…³ç³»å’Œåˆ é™¤é€»è¾‘ã€‚
    
- **å…³é”®å‡½æ•°**ï¼š
    
    - **`SetControllerReference(owner, controlled, scheme)`**:
        
        - **ä¼ å‚**ï¼šçˆ¶å¯¹è±¡ã€å­å¯¹è±¡ã€Scheme æˆ·å£æœ¬ã€‚
            
        - **è¿”å›**ï¼š`error`ã€‚
            
        - **ä»€ä¹ˆæ—¶å€™ç”¨**ï¼šåœ¨ `r.Create()` å­èµ„æºä¹‹å‰è°ƒç”¨ï¼Œç¡®ä¿å­èµ„æºå‡ºç”Ÿå°±æœ‰â€œçˆ¶äº²â€ã€‚
            
    - **`Add/RemoveFinalizer(obj, string)`**:
        
        - **ä¸ºä»€ä¹ˆè¦ç”¨**ï¼šå½“èµ„æºè¢«åˆ æ—¶ï¼Œä½ æƒ³åœ¨å®ƒå½»åº•æ¶ˆå¤±å‰æ‰§è¡Œä¸€äº›åŠ¨ä½œï¼ˆå¦‚æ¸…ç†äº‘ç«¯æ•°æ®åº“ï¼‰ï¼Œå¿…é¡»ç”¨è¿™ä¸ªé˜²æ­¢å®ƒè¢«ç¬é—´æŠ¹é™¤ã€‚
            

## ğŸ’¡ å¼€å‘æœ€ä½³å®è·µ (Best Practices)

1. **å¹‚ç­‰æ€§ (Idempotency) ç¬¬ä¸€åŸåˆ™**ï¼š æ°¸è¿œå‡è®¾ä½ çš„ä»£ç ä¼šåœ¨ä»»ä½•ä¸€è¡ŒæŠ¥é”™é€€å‡ºã€‚å½“å®ƒç¬¬äºŒæ¬¡è¿›æ¥æ—¶ï¼Œå¿…é¡»èƒ½æ¥ä¸Šè¿›åº¦ã€‚**åšæ³•ï¼š** æ¯æ¬¡æ“ä½œå‰å…ˆ `Get` æŸ¥ä¸€ä¸‹ï¼Œå­˜åœ¨å°±ä¸åˆ›å»ºï¼Œä¸€è‡´å°±ä¸æ›´æ–°ã€‚
    
2. **è¯»å†™åˆ†ç¦»**ï¼š `client.Client` é»˜è®¤ä»ç¼“å­˜è¯»ï¼Œå¾€é›†ç¾¤å†™ã€‚ä¸è¦æ‰‹åŠ¨å»å†™ç¼“å­˜ï¼Œå§‹ç»ˆç›¸ä¿¡ `r.Get` æ‹¿åˆ°çš„å°±æ˜¯å½“å‰çš„æœ€ä¼˜çŠ¶æ€ã€‚
    
3. **ç»†é¢—ç²’åº¦çš„ RBAC æƒé™**ï¼š åªç»™ Operator ç”³è¯·å®ƒéœ€è¦çš„æƒé™ã€‚å¦‚æœä½ åªéœ€è¦æ”¹ Podï¼Œä¸è¦ç”³è¯·é›†ç¾¤çº§åˆ«çš„æƒé™ã€‚
    
4. **çŠ¶æ€é©±åŠ¨ (State Driven)**ï¼š ä¸è¦è®©ä½ çš„ Operator è¯•å›¾å»è®°ä½å†å²ï¼Œå®ƒåº”è¯¥åƒä¸€ä¸ªâ€œé‡‘é±¼â€ï¼Œæ¯æ¬¡è¿›æ¥éƒ½é€šè¿‡è§‚å¯Ÿç°åœ¨çš„é›†ç¾¤çŠ¶æ€æ¥å†³å®šä¸‹ä¸€æ­¥ã€‚
    

## ğŸ› ï¸ æ¨èçš„å¼€å‘è·¯å¾„ (Roadmap)

1. **è„šæ‰‹æ¶ç”Ÿæˆ**ï¼š ä½¿ç”¨ `kubebuilder init` å’Œ `create api` ç”Ÿæˆä»£ç æ¡†æ¶ã€‚
    
2. **å®šä¹‰ Spec (æ•°æ®æ¨¡å‹)**ï¼š åœ¨ `_types.go` é‡Œæƒ³æ¸…æ¥šç”¨æˆ·éœ€è¦å¡«ä»€ä¹ˆå‚æ•°ã€‚**åŸåˆ™ï¼š** å­—æ®µè¶Šå°‘è¶Šå¥½ï¼Œèƒ½æ¨å¯¼å‡ºæ¥çš„å­—æ®µä¸è¦è®©ç”¨æˆ·å¡«ã€‚
    
3. **ç¼–å†™ Reconcile (æ ¸å¿ƒé€»è¾‘)**ï¼š æŒ‰ç…§â€œè·å– CR -> è·å–å­èµ„æº -> å¯¹æ¯”å·®å¼‚ -> æ‰§è¡ŒåŒæ­¥ -> æ›´æ–° Statusâ€çš„äº”æ­¥æ³•å†™é€»è¾‘ã€‚
    
4. **æœ¬åœ°æµ‹è¯• (Local Debug)**ï¼š åˆ©ç”¨ Minikubeï¼Œç›´æ¥åœ¨æœ¬åœ°è¿è¡Œ `make install` å’Œ `make run`ã€‚è¿™æ ·ä½ å¯ä»¥åœ¨ IDE é‡Œæ‰“æ–­ç‚¹çœ‹å˜é‡ã€‚
    
5. **é•œåƒéƒ¨ç½²**ï¼š æµ‹è¯•å®Œæˆåï¼Œæ‰§è¡Œ `make docker-build docker-push` å’Œ `make deploy` å°† Operator çœŸæ­£è¿è¡Œåœ¨é›†ç¾¤é‡Œã€‚
# å®æˆ˜

## å®šä¹‰æ•°æ®æ¨¡å‹

**å®šä¹‰æ•°æ®æ¨¡å‹ï¼ˆSchemaï¼‰â€”â€” è®¾è®¡ä½ çš„â€œèµ„æºåè®®â€**ã€‚

åœ¨ Kubernetes ä¸­ï¼Œæ‰€æœ‰çš„èµ„æºæœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€æ®µ JSONã€‚åœ¨è¿™ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬è¦å»ä¿®æ”¹ `api/v1/myconfig_types.go` æ–‡ä»¶ï¼Œå†³å®šç”¨æˆ·åœ¨ YAML é‡Œèƒ½å¡«ä»€ä¹ˆå‚æ•°ï¼ˆSpecï¼‰ï¼Œä»¥åŠæˆ‘ä»¬çš„ Operator åé¦ˆä»€ä¹ˆä¿¡æ¯ï¼ˆStatusï¼‰ã€‚
### 1. æ˜ç¡®æˆ‘ä»¬è¦å®ç°çš„å­—æ®µ

æˆ‘ä»¬è¦åšçš„ `MyConfig` èµ„æºï¼Œç›®æ ‡æ˜¯ç”Ÿæˆä¸€ä¸ª `ConfigMap`ã€‚

- **æœŸæœ›ï¼ˆSpecï¼‰**ï¼šç”¨æˆ·éœ€è¦æä¾› `ConfigMap` çš„æ•°æ®å†…å®¹ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª `Data` å­—æ®µã€‚
    
- **çŠ¶æ€ï¼ˆStatusï¼‰**ï¼šæˆ‘ä»¬è¦å‘Šè¯‰ç”¨æˆ·è¿™ä¸ª ConfigMap æ˜¯å¦å·²ç»åŒæ­¥æˆåŠŸï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª `SyncStatus` å­—æ®µã€‚
    

### 2. ä¿®æ”¹ `api/v1/myconfig_types.go`

æ‰¾åˆ° `MyConfigSpec` å’Œ `MyConfigStatus` ç»“æ„ä½“ï¼ŒæŒ‰å¦‚ä¸‹æ–¹å¼ä¿®æ”¹ï¼š

```go
// MyConfigSpec å®šä¹‰äº†ç”¨æˆ·å¸Œæœ›çœ‹åˆ°çš„èµ„æºçŠ¶æ€
type MyConfigSpec struct {
	// Data æ˜¯æˆ‘ä»¬è¦å­˜å…¥ ConfigMap çš„é”®å€¼å¯¹æ•°æ®
	// +kubebuilder:validation:Required (è¿™æ˜¯ä¸€ä¸ªæ³¨è§£ï¼Œè¡¨ç¤ºè¯¥å­—æ®µå¿…å¡«)
	Data map[string]string `json:"data"`
}

// MyConfigStatus å®šä¹‰äº†èµ„æºçš„å®é™…è¿è¡ŒçŠ¶æ€
type MyConfigStatus struct {
	// SyncStatus è¡¨ç¤ºåŒæ­¥ç»“æœï¼šSuccess æˆ– Failed
	SyncStatus string `json:"syncStatus,omitempty"`

	// LastSyncTime è®°å½•æœ€åä¸€æ¬¡æˆåŠŸåŒæ­¥çš„æ—¶é—´
	LastSyncTime *metav1.Time `json:"lastSyncTime,omitempty"`
}

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status  <-- ã€å…³é”®ï¼ã€‘å¿…é¡»æœ‰è¿™ä¸€è¡Œæ‰èƒ½æ›´æ–° Status å­èµ„æº
// +kubebuilder:printcolumn:name="Status",type="string",JSONPath=".status.syncStatus" <-- ã€è¿›é˜¶ã€‘è®© kubectl get ä¹Ÿèƒ½ç›´æ¥çœ‹åˆ°çŠ¶æ€

// MyConfig æ˜¯ MyConfig èµ„æºçš„ç»“æ„ä½“å®šä¹‰
type MyConfig struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	Spec   MyConfigSpec   `json:"spec,omitempty"`
	Status MyConfigStatus `json:"status,omitempty"`
}
```

## ğŸ” æ·±åº¦æ‹†è§£ï¼šä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ

### â‘  `+kubebuilder:subresource:status`

- ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ
    
    Kubernetes å°†èµ„æºåˆ†ä¸ºâ€œä¸»èµ„æºâ€å’Œâ€œå­èµ„æºâ€ã€‚å¦‚æœä½ ä¸åŠ è¿™è¡Œæ³¨é‡Šï¼Œä½ çš„ Operator åœ¨å°è¯•è°ƒç”¨ r.Status().Update() æ—¶ä¼šæŠ¥é”™ï¼Œå› ä¸º API Server ä¼šè®¤ä¸ºè¿™ä¸ªèµ„æºæ²¡æœ‰ status è¿™ä¸ªæ¥å£ã€‚
    
- ä¸è¿™ä¹ˆåšçš„åæœï¼š
    
    ä½ çš„ Operator é€»è¾‘èƒ½è·‘ï¼Œä½†æ˜¯æ— æ³•æŠŠè¿è¡Œç»“æœï¼ˆæ¯”å¦‚â€œåŒæ­¥æˆåŠŸâ€ï¼‰åé¦ˆç»™ç”¨æˆ·ã€‚ç”¨æˆ·æ‰§è¡Œ kubectl get myconfig -o yaml æ—¶ï¼Œstatus æ°¸è¿œæ˜¯ç©ºçš„ã€‚
    

### â‘¡ JSON æ ‡ç­¾ (`` `json:"data"` ``)

- ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ
    
    Go è¯­è¨€çš„å˜é‡é¦–å­—æ¯å¿…é¡»å¤§å†™ï¼ˆPublicï¼‰æ‰èƒ½è¢«å…¶ä»–åŒ…è®¿é—®ï¼Œä½† Kubernetes çš„ YAML è§„èŒƒä¹ æƒ¯ä½¿ç”¨å°å†™ï¼ˆå¦‚ spec.dataï¼‰ã€‚è¿™ä¸ªæ ‡ç­¾å°±æ˜¯ç¿»è¯‘å®˜ã€‚
    
- ä¸è¿™ä¹ˆåšçš„åæœï¼š
    
    å¦‚æœä½ æ¼æ‰äº†æ ‡ç­¾æˆ–è€…å†™é”™äº†ï¼Œç”¨æˆ·åœ¨ YAML é‡Œå¡«äº† dataï¼ŒGo ä»£ç é‡Œçš„ Data å˜é‡æ‹¿ä¸åˆ°ä»»ä½•å€¼ã€‚
    

### â‘¢ `+kubebuilder:printcolumn` (æœ€ä½³å®è·µ)

- ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ
    
    ä½ ä¸€å®šç”¨è¿‡ kubectl get podsï¼Œå®ƒä¼šæ˜¾ç¤º STATUSã€AGE ç­‰åˆ—ã€‚è¿™è¡Œä»£ç å°±æ˜¯è®©ä½ è‡ªå®šä¹‰ kubectl get myconfig æ—¶çš„æ˜¾ç¤ºåˆ—ã€‚
    
- ä¸è¿™ä¹ˆåšçš„åæœï¼š
    
    ä¸åŠ è¿™è¡Œï¼Œä½ æ‰§è¡Œ kubectl get myconfig æ—¶åªèƒ½çœ‹åˆ°åå­—ï¼Œå¿…é¡»åŠ  -o yaml æ‰èƒ½çœ‹åˆ°åŒæ­¥ç»“æœï¼Œéå¸¸ä¸ç›´è§‚ã€‚

## 3. ç”Ÿæˆ Manifests (åŒæ­¥ä»£ç åˆ° YAML)

æ¯å½“ä½ ä¿®æ”¹äº† `_types.go` æ–‡ä»¶ï¼Œä½ å¿…é¡»è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¦åˆ™ Kubernetes ä¸è®¤è¯†è¿™äº›æ–°å­—æ®µï¼š

Bash

```
make manifests
```

- è¿™ä¸ªå‡½æ•°å¹²äº†ä»€ä¹ˆï¼Ÿ
    
    å®ƒä¼šæ‰«æä½ çš„ Go ä»£ç å’Œæ³¨é‡Šï¼ˆé‚£äº› +kubebuilder å¼€å¤´çš„è¡Œï¼‰ï¼Œç„¶ååœ¨ config/crd/bases/ ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªåºå¤§çš„ YAML æ–‡ä»¶ã€‚
    
- ä¸è¿™ä¹ˆåšçš„åæœï¼š
    
    å³ä½¿ä½ ä»£ç å†™å¾—å®Œç¾ï¼Œåªè¦æ²¡æ‰§è¡Œè¿™ä¸€æ­¥ï¼Œå½“ä½ æŠŠ YAML å‘ç»™é›†ç¾¤æ—¶ï¼Œé›†ç¾¤ä¼šæŠ¥é”™ï¼šunknown field "data" in specã€‚

## å°† CRD å®‰è£…åˆ° Minikube

ç°åœ¨ï¼Œæˆ‘ä»¬è¦æŠŠè¿™ä¸ªâ€œè®¾è®¡å›¾â€äº¤ç»™ Minikubeã€‚

```bash
make install
```

- éªŒè¯ç»“æœï¼š
    
    æ‰§è¡Œ kubectl get crds | grep myconfigs
    
    å¦‚æœä½ çœ‹åˆ°äº† myconfigs.web.example.comï¼Œè¯´æ˜ä½ å·²ç»åœ¨é›†ç¾¤é‡ŒæˆåŠŸç™»è®°äº†ä½ çš„æ–°èµ„æºç±»å‹ï¼

## ç¼–å†™ Reconcile é€»è¾‘

æˆ‘ä»¬å°†åˆ†ä¸‰æ­¥å®Œæˆæ§åˆ¶å™¨çš„ç¼–å†™ï¼šè®¾ç½®æƒé™ã€å»ºç«‹é€»è¾‘å¾ªç¯ã€å®ç°çˆ¶å­ç»‘å®šã€‚

### è®¾ç½® RBAC æƒé™ï¼ˆå¿…é¡»å…ˆåšï¼‰

åœ¨ `Reconcile` å‡½æ•°ä¸Šæ–¹ï¼Œä½ ä¼šçœ‹åˆ°ä¸€å †ä»¥ `// +kubebuilder:rbac` å¼€å¤´çš„æ³¨é‡Šã€‚è¿™äº›**ä¸æ˜¯æ™®é€šæ³¨é‡Š**ï¼Œå®ƒä»¬æ˜¯æƒé™å£°æ˜ã€‚

**æ“ä½œï¼š** æ‰¾åˆ°è¿™äº›è¡Œï¼Œç¡®ä¿æ·»åŠ äº†å¯¹ `configmaps` çš„æƒé™ï¼š

```go
// +kubebuilder:rbac:groups=web.example.com,resources=myconfigs,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=web.example.com,resources=myconfigs/status,verbs=get;update;patch
// +kubebuilder:rbac:groups="",resources=configmaps,verbs=get;list;watch;create;update;patch;delete
```

- ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ
    
    Kubernetes é»˜è®¤æ˜¯ä¸å…è®¸ä»»ä½•ç¨‹åºéšæ„åˆ›å»ºèµ„æºçš„ã€‚è¿™äº›æ³¨é‡Šä¼šè¢« make manifests è½¬åŒ–æˆé›†ç¾¤çš„ ClusterRoleã€‚
    
- ä¸è¿™ä¹ˆåšçš„åæœï¼š
    
    ä½ çš„ä»£ç è¿è¡Œåˆ° r.Create(configMap) æ—¶ä¼šç›´æ¥å´©æºƒï¼ŒæŠ¥é”™ Forbiddenï¼ˆæ— æƒæ“ä½œï¼‰ã€‚

### å®ç°æ ¸å¿ƒè°ƒè§£é€»è¾‘ (Reconcile)

æˆ‘ä»¬å°†é‡å†™ `Reconcile` å‡½æ•°ã€‚è¯·ä»”ç»†é˜…è¯»ä»£ç ä¸­çš„ä¸­æ–‡æ³¨é‡Šï¼š

```go
func (r *MyConfigReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
	// 1. åˆå§‹åŒ–æ—¥å¿—å¯¹è±¡ï¼Œæ–¹ä¾¿è°ƒè¯•
	l := log.FromContext(ctx)

	// 2. è·å–ç”¨æˆ·åˆ›å»ºçš„ MyConfig å®ä¾‹
	// æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªç©ºçš„ç»“æ„ä½“ï¼Œç„¶åè®© Client å»å¡«å……å®ƒ
	myConfig := &webv1.MyConfig{}
	err := r.Get(ctx, req.NamespacedName, myConfig)
	if err != nil {
		// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜èµ„æºå¯èƒ½è¢«åˆ é™¤äº†
		return ctrl.Result{}, client.IgnoreNotFound(err)
	}

	// 3. å®šä¹‰æˆ‘ä»¬â€œæœŸæœ›â€çš„ ConfigMap é•¿ä»€ä¹ˆæ ·
	// æˆ‘ä»¬æŠŠè¿™ä¸ªé€»è¾‘æŠ½ç¦»æˆä¸€ä¸ªå•ç‹¬çš„å‡½æ•°ï¼ˆè§ä¸‹æ–‡ï¼‰
	cm, err := r.desiredConfigMap(myConfig)
	if err != nil {
		return ctrl.Result{}, err
	}

	// 4. æ£€æŸ¥é›†ç¾¤ä¸­æ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ª ConfigMap
	foundCM := &corev1.ConfigMap{}
	err = r.Get(ctx, types.NamespacedName{Name: cm.Name, Namespace: cm.Namespace}, foundCM)

	if err != nil && errors.IsNotFound(err) {
		// --- åœºæ™¯ Aï¼šConfigMap ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ›å»º ---
		l.Info("æ­£åœ¨åˆ›å»º ConfigMap", "Name", cm.Name)
		if err := r.Create(ctx, cm); err != nil {
			return ctrl.Result{}, err
		}
		// åˆ›å»ºæˆåŠŸåï¼Œæ›´æ–°çŠ¶æ€
		return r.updateStatus(ctx, myConfig, "Success")
		
	} else if err != nil {
		// å‘ç”Ÿäº†å…¶ä»–è¯»å–é”™è¯¯
		return ctrl.Result{}, err
	}

	// --- åœºæ™¯ Bï¼šConfigMap å·²å­˜åœ¨ï¼Œå¯¹æ¯”æ•°æ®æ˜¯å¦ä¸€è‡´ ---
	// ç›®çš„ï¼šå®ç°â€œå¹‚ç­‰æ€§â€ï¼Œå¦‚æœç”¨æˆ·æ”¹äº† MyConfig çš„ Dataï¼Œæˆ‘ä»¬è¦åŒæ­¥æ›´æ–° ConfigMap
	if !reflect.DeepEqual(foundCM.Data, myConfig.Spec.Data) {
		l.Info("æ•°æ®ä¸ä¸€è‡´ï¼Œæ­£åœ¨æ›´æ–° ConfigMap", "Name", cm.Name)
		foundCM.Data = myConfig.Spec.Data
		if err := r.Update(ctx, foundCM); err != nil {
			return ctrl.Result{}, err
		}
	}

	return ctrl.Result{}, nil
}
```

### å®ç°â€œçˆ¶å­ç»‘å®šâ€ï¼ˆå…³é”®å‡½æ•°ï¼‰

è¿™æ˜¯å®ç°è‡ªåŠ¨æ¸…ç†å’Œå…³è”çš„æ ¸å¿ƒã€‚æˆ‘ä»¬åœ¨æ§åˆ¶å™¨ç±»ä¸‹å¢åŠ è¿™ä¸ªè¾…åŠ©å‡½æ•°ï¼š

```go
func (r *MyConfigReconciler) desiredConfigMap(myConfig *webv1.MyConfig) (*corev1.ConfigMap, error) {
	cm := &corev1.ConfigMap{
		ObjectMeta: metav1.ObjectMeta{
			Name:      myConfig.Name, // åå­—å’Œçˆ¶èµ„æºä¿æŒä¸€è‡´
			Namespace: myConfig.Namespace,
		},
		Data: myConfig.Spec.Data, // ä½¿ç”¨æˆ‘ä»¬åœ¨ Spec ä¸­å®šä¹‰çš„ Data
	}

	// ã€æ ¸å¿ƒï¼šçˆ¶å­ç»‘å®šã€‘
	// å‚æ•° 1: çˆ¶èµ„æº (MyConfig)
	// å‚æ•° 2: å­èµ„æº (ConfigMap)
	// å‚æ•° 3: æˆ·å£æœ¬ (r.Scheme)
	// ç›®çš„ï¼šåœ¨ ConfigMap çš„ Metadata ä¸­æ³¨å…¥ OwnerReference
	if err := controllerutil.SetControllerReference(myConfig, cm, r.Scheme); err != nil {
		return nil, err
	}

	return cm, nil
}
```

- ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ
    
    è¿™æ˜¯ Operator çš„æœ€ä½³å®è·µã€‚è®¾ç½®äº† OwnerReference åï¼Œå½“ä½  kubectl delete myconfig ... æ—¶ï¼ŒK8s ä¼šè‡ªåŠ¨å¸®ä½ åˆ æ‰è¿™ä¸ªå¯¹åº”çš„ ConfigMapã€‚
    
- ä¸è¿™ä¹ˆåšçš„åæœï¼š
    
    èµ„æºä¼šå‘ç”Ÿâ€œæ³„éœ²â€ã€‚ä½ çš„è‡ªå®šä¹‰èµ„æºåˆ äº†ï¼Œä½†å®ƒç•™ä¸‹çš„åƒåœ¾ï¼ˆConfigMapï¼‰ä¼šæ°¸è¿œç•™åœ¨é›†ç¾¤é‡Œï¼Œå ç”¨å‘½åç©ºé—´ã€‚

### æ›´æ–°çŠ¶æ€ (Status Update)

```go
func (r *MyConfigReconciler) updateStatus(ctx context.Context, myConfig *webv1.MyConfig, status string) (ctrl.Result, error) {
	myConfig.Status.SyncStatus = status
	now := metav1.Now()
	myConfig.Status.LastSyncTime = &now

	// æ³¨æ„ï¼šä½¿ç”¨ r.Status().Update è€Œä¸æ˜¯ r.Update
	if err := r.Status().Update(ctx, myConfig); err != nil {
		return ctrl.Result{}, err
	}
	return ctrl.Result{}, nil
}
```

- ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ
    
    è®©ç”¨æˆ·èƒ½çœ‹åˆ°ç»“æœã€‚
    
- ä¸è¿™ä¹ˆåšçš„åæœï¼š
    
    ç”¨æˆ·ä¸çŸ¥é“ Operator æ˜¯å¦åœ¨å¹²æ´»ï¼Œåªèƒ½å»ç¿»æ—¥å¿—ï¼Œæ•ˆç‡æä½ã€‚

## ç›‘å¬

```go
func (r *MyConfigReconciler) SetupWithManager(mgr ctrl.Manager) error {
    return ctrl.NewControllerManagedBy(mgr).
        For(&webv1.MyConfig{}).
        Owns(&corev1.ConfigMap{}). // <--- å¿…é¡»æœ‰è¿™ä¸€è¡Œï¼
        Complete(r)
}
```


å½“ä½ å†™ä¸‹ `For` å’Œ `Owns` æ—¶ï¼Œåº•å±‚çš„ `controller-runtime` å…¶å®åœ¨ä¸ºä½ åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š

#### â‘  æ³¨å†Œäº‹ä»¶å¤„ç†å™¨ (Event Handlers)

- **`For(&webv1.MyConfig{})`**: å‘ K8s æ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ï¼ˆInformerï¼‰ã€‚ä¸€æ—¦ `MyConfig` èµ„æºæœ‰ **Create/Update/Delete** åŠ¨ä½œï¼ŒK8s å°±ä¼šæŠŠè¿™ä¸ªäº‹ä»¶æ‰”è¿›ä¸€ä¸ª**å·¥ä½œé˜Ÿåˆ— (WorkQueue)**ã€‚
    
- **`Owns(&corev1.ConfigMap{})`**: åŒæ ·æ³¨å†Œä¸€ä¸ªé’ˆå¯¹ `ConfigMap` çš„ç›‘å¬å™¨ã€‚
    

#### â‘¡ è‡ªåŠ¨è¿‡æ»¤ä¸æ˜ å°„ (Map to Owner)

è¿™æ˜¯ `Owns` æœ€ç¥å¥‡çš„åœ°æ–¹ã€‚ å½“ä¸€ä¸ª `ConfigMap` å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œ`controller-runtime` ä¸ä¼šç›²ç›®åœ°è§¦å‘ `Reconcile`ã€‚å®ƒä¼šæ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š

1. **æ£€æŸ¥ Metadata**ï¼šæŸ¥çœ‹è¿™ä¸ª `ConfigMap` çš„ `ownerReferences` åˆ—è¡¨ã€‚
    
2. **åŒ¹é…ç±»å‹**ï¼šçœ‹çœ‹é‡Œé¢æœ‰æ²¡æœ‰ä¸€ä¸ª `Owner` çš„ `Kind` æ˜¯ `MyConfig`ï¼Œä¸” `Controller` å­—æ®µä¸º `true`ã€‚
    
3. **è·å–åå­—**ï¼šå¦‚æœæœ‰ï¼Œæå–å‡ºé‚£ä¸ª `MyConfig` çš„ `Name`ã€‚
    
4. **è§¦å‘çˆ¶èµ„æº**ï¼šæŠŠè¿™ä¸ª**çˆ¶èµ„æºçš„åå­—**æ‰”è¿›å·¥ä½œé˜Ÿåˆ—ï¼Œè§¦å‘ `Reconcile` å‡½æ•°ã€‚
    

> **é‡ç‚¹ï¼š** ä½ çš„ `Reconcile` å‡½æ•°æ¥æ”¶åˆ°çš„ `req.Name` æ°¸è¿œæ˜¯ **çˆ¶èµ„æº (MyConfig)** çš„åå­—ï¼Œå³ä½¿åˆšæ‰å˜åŠ¨çš„æ˜¯ **å­èµ„æº (ConfigMap)**ã€‚è¿™ä¿è¯äº†ä½ çš„é€»è¾‘å§‹ç»ˆä»â€œæºå¤´â€å¼€å§‹æ£€æŸ¥ã€‚

### éœ€è¦ä¿®æ”¹æ­¤å‡½æ•°çš„ 3 å¤§å¸¸è§åœºæ™¯

é™¤äº†åŸºç¡€çš„ `For` å’Œ `Owns`ï¼Œå®é™…å¼€å‘ä¸­ä¸ºäº†æé«˜æ€§èƒ½å’Œå¤„ç†å¤æ‚é€»è¾‘ï¼Œç»å¸¸éœ€è¦ä¿®æ”¹å®ƒã€‚

#### åœºæ™¯ä¸€ï¼šé˜²æ­¢â€œçŠ¶æ€æ›´æ–°â€å¯¼è‡´çš„æ­»å¾ªç¯ (ä½¿ç”¨ Predicates)

**é—®é¢˜**ï¼šå½“ä½ åœ¨ `Reconcile` ä¸­æ›´æ–° `Status` æ—¶ï¼ŒK8s ä¼šè®¤ä¸ºèµ„æºå˜äº†ï¼Œå†æ¬¡è§¦å‘ `Reconcile`ã€‚å¦‚æœä¸åŠ æ§åˆ¶ï¼Œä¼šé™·å…¥ï¼šæ›´æ–°çŠ¶æ€ -> è§¦å‘ -> æ›´æ–°çŠ¶æ€çš„æ­»å¾ªç¯ã€‚ **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `Predicate` è¿‡æ»¤æ‰é `Spec` çš„æ›´æ–°ã€‚

```go
import (
    "sigs.k8s.io/controller-runtime/pkg/predicate"
    "sigs.k8s.io/controller-runtime/pkg/event"
)

func (r *MyConfigReconciler) SetupWithManager(mgr ctrl.Manager) error {
    return ctrl.NewControllerManagedBy(mgr).
        For(&webv1.MyConfig{}).
        Owns(&corev1.ConfigMap{}).
        // ã€æ–°å¢ï¼šè¿‡æ»¤å™¨ã€‘
        WithEventFilter(predicate.Funcs{
            UpdateFunc: func(e event.UpdateEvent) bool {
                // åªæœ‰å½“ Spec (Generation) å‘ç”Ÿå˜åŒ–æ—¶æ‰è§¦å‘è°ƒè§£
                // å¦‚æœåªæ˜¯ Status å˜åŒ–ï¼ŒGeneration æ˜¯ä¸ä¼šå˜çš„
                return e.ObjectOld.GetGeneration() != e.ObjectNew.GetGeneration()
            },
        }).
        Complete(r)
}
```

#### åœºæ™¯äºŒï¼šç›‘å¬â€œéæ‰€å±â€çš„å¤–éƒ¨èµ„æº (ä½¿ç”¨ Watches)

**é—®é¢˜**ï¼šå‡è®¾ä½ çš„ `MyConfig` é€»è¾‘ä¾èµ–äºä¸€ä¸ªå…¨å±€çš„ `Secret`ï¼ˆæ¯”å¦‚æ•°æ®åº“è¯ä¹¦ï¼‰ï¼Œä½†è¿™ä¸ª `Secret` å¹¶ä¸æ˜¯ç”± `MyConfig` åˆ›å»ºçš„ï¼ˆæ²¡æœ‰ Owner ç»‘å®šï¼‰ã€‚å½“ `Secret` å˜åŒ–æ—¶ï¼Œä½ ä¹Ÿéœ€è¦é‡æ–°åŒæ­¥ã€‚ **è§£å†³æ–¹æ¡ˆ**ï¼šæ‰‹åŠ¨å»ºç«‹æ˜ å°„å…³ç³»ã€‚

```go
import (
    "sigs.k8s.io/controller-runtime/pkg/handler"
    "sigs.k8s.io/controller-runtime/pkg/source"
)

func (r *MyConfigReconciler) SetupWithManager(mgr ctrl.Manager) error {
    return ctrl.NewControllerManagedBy(mgr).
        For(&webv1.MyConfig{}).
        Owns(&corev1.ConfigMap{}).
        // ã€æ–°å¢ï¼šç›‘å¬ç¬¬ä¸‰æ–¹èµ„æºã€‘
        Watches(
            &source.Kind{Type: &corev1.Secret{}},
            handler.EnqueueRequestsFromMapFunc(func(obj client.Object) []reconcile.Request {
                // è¿™é‡Œå†™é€»è¾‘ï¼šå½“ä»»ä½• Secret å˜åŒ–æ—¶ï¼Œæ‰¾å‡ºå—å½±å“çš„ MyConfig åå­—
                // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œå‡è®¾è§¦å‘æ‰€æœ‰å‘½åç©ºé—´ä¸‹çš„ myconfig-test
                return []reconcile.Request{
                    {NamespacedName: types.NamespacedName{Name: "myconfig-test", Namespace: obj.GetNamespace()}},
                }
            }),
        ).
        Complete(r)
}
```

#### åœºæ™¯ä¸‰ï¼šæ§åˆ¶å¹¶å‘å¤„ç†é€Ÿåº¦

**é—®é¢˜**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒOperator æ˜¯ä¸€æ¬¡å¤„ç†ä¸€ä¸ª `Reconcile`ã€‚å¦‚æœä½ çš„é›†ç¾¤è§„æ¨¡å¾ˆå¤§ï¼Œå¤„ç†é€Ÿåº¦å¤ªæ…¢ã€‚ **è§£å†³æ–¹æ¡ˆ**ï¼šå¢åŠ å¹¶å‘ worker æ•°ã€‚

```go
import "sigs.k8s.io/controller-runtime/pkg/controller"

func (r *MyConfigReconciler) SetupWithManager(mgr ctrl.Manager) error {
    return ctrl.NewControllerManagedBy(mgr).
        For(&webv1.MyConfig{}).
        Owns(&corev1.ConfigMap{}).
        // ã€æ–°å¢ï¼šå¹¶å‘é…ç½®ã€‘
        WithOptions(controller.Options{
            MaxConcurrentReconciles: 10, // åŒæ—¶è·‘ 10 ä¸ªè°ƒè§£åç¨‹
        }).
        Complete(r)
}
```

### æ€»ç»“

- **`For`**: å®šä¹‰ä½ çš„ä¸»è¦è§‚å¯Ÿå¯¹è±¡ã€‚
    
- **`Owns`**: å®šä¹‰ä½ çš„ç›´æ¥ä¸‹å±ï¼ˆè‡ªåŠ¨åå‘æ˜ å°„ï¼‰ã€‚
    
- **`Watches`**: å®šä¹‰è·Ÿä½ æ²¡äº²æˆšå…³ç³»ä½†ä½ å¾ˆå…³å¿ƒçš„â€œé‚»å±…â€ã€‚
    
- **`WithEventFilter`**: é—­ä¸Šçœ¼ä¸çœ‹é‚£äº›æ²¡æ„ä¹‰çš„çç¢å˜åŠ¨ã€‚