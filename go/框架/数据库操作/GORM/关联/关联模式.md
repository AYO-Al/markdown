# 创建时自动保存关联

```go
user := User{
  Name:            "jinzhu",
  BillingAddress:  Address{Address1: "Billing Address - Address 1"},
  ShippingAddress: Address{Address1: "Shipping Address - Address 1"},
  Emails:          []Email{
    {Email: "jinzhu@example.com"},
    {Email: "jinzhu-2@example.com"},
  },
  Languages:       []Language{
    {Name: "ZH"},
    {Name: "EN"},
  },
}

// Creating a user along with its associated addresses, emails, and languages
db.Create(&user)
// BEGIN TRANSACTION;
// INSERT INTO "addresses" (address1) VALUES ("Billing Address - Address 1"), ("Shipping Address - Address 1") ON DUPLICATE KEY DO NOTHING;
// INSERT INTO "users" (name,billing_address_id,shipping_address_id) VALUES ("jinzhu", 1, 2);
// INSERT INTO "emails" (user_id,email) VALUES (111, "jinzhu@example.com"), (111, "jinzhu-2@example.com") ON DUPLICATE KEY DO NOTHING;
// INSERT INTO "languages" ("name") VALUES ('ZH'), ('EN') ON DUPLICATE KEY DO NOTHING;
// INSERT INTO "user_languages" ("user_id","language_id") VALUES (111, 1), (111, 2) ON DUPLICATE KEY DO NOTHING;
// COMMIT;

db.Save(&user)
```
# 使用 `FullSaveAssociations` 更新关联

对于需要完全更新关联数据（而不仅仅是外键引用）的情况，应该使用 `FullSaveAssociations` 模式。

```go
// Update a user and fully update all its associations
db.Session(&gorm.Session{FullSaveAssociations: true}).Updates(&user)
// SQL: Fully updates addresses, users, emails tables, including existing associated records

```

使用 `FullSaveAssociations` 可确保模型的整个状态（包括其所有关联）反映在数据库中，从而维护整个应用程序的数据完整性和一致性。

| 特性            | 使用 `FullSaveAssociations` | 直接更新        |
| ------------- | ------------------------- | ----------- |
| ​**​关联处理​**​  | 自动保存所有嵌套关联                | 只更新主模型，忽略关联 |
| ​**​零值处理​**​  | 更新所有字段（包括零值）              | 默认忽略零值      |
| ​**​创建/更新​**​ | 自动判断创建或更新关联               | 需要手动处理关联    |
| ​**​性能影响​**​  | 可能产生多个 SQL 操作             | 单个 SQL 操作   |
```go
user := User{
    ID: 1,
    Name: "更新后的名字",
    Age: 30,
    Profile: Profile{
        Bio: "新的个人简介",  // 这个关联不会被保存！
    },
}

// 只更新 User 表，Profile 完全被忽略
db.Save(&user)
// 等价于：db.Model(&User{ID: 1}).Updates(User{Name: "更新后的名字", Age: 30})

// 生成的 SQL：
// UPDATE users SET name = '更新后的名字', age = 30 WHERE id = 1;
// Profile 表：没有任何操作


user := User{
    ID: 1,
    Name: "更新后的名字", 
    Age: 30,
    Profile: Profile{
        Bio: "新的个人简介",  // 这个关联会被保存！
    },
}

// 更新 User 和所有关联
db.Session(&gorm.Session{FullSaveAssociations: true}).Save(&user)

// 生成的 SQL：
// UPDATE users SET name = '更新后的名字', age = 30 WHERE id = 1;
// UPDATE profiles SET bio = '新的个人简介' WHERE user_id = 1;

```
# 跳过自动更新

GORM 提供了灵活性，可以在创建或更新操作期间跳过关联的自动保存。这可以通过使用 `Select` 或 `Omit` 方法来实现，它们允许您精确指定在操作中应包含或排除哪些字段或关联。
## 使用Select包含特定字段

`Select` 方法允许您指定要保存模型的哪些字段。这意味着只有选定的字段才会包含在 SQL 操作中。

```go
user := User{
  // User and associated data
}

// Only include the 'Name' field when creating the user
db.Select("Name").Create(&user)
// SQL: INSERT INTO "users" (name) VALUES ("jinzhu");

```
## 使用 Omit 来排除字段或关联

相反， `Omit` 允许您在保存模型时排除某些字段或关联。

```go
// Skip creating the 'BillingAddress' when creating the user
db.Omit("BillingAddress").Create(&user)

// Skip all associations when creating the user
db.Omit(clause.Associations).Create(&user)

```

对于多对多关联，GORM 会在创建连接表引用之前更新关联。要跳过此更新操作，请使用 Omit 并在关联名称后加 .* ：

```go
// Skip upserting 'Languages' associations
db.Omit("Languages.*").Create(&user)
To skip creating both the association and its references:
```

要跳过创建关联及其引用：

```go
// Skip creating 'Languages' associations and their references
db.Omit("Languages").Create(&user)
```

## 删除关联

GORM 允许在删除主记录时使用 `Select` 方法删除特定的关联关系（例如，一对多、多对多）。此功能对于维护数据库完整性以及确保在删除时对关联数据进行适当的管理特别有用。

```go
// Delete a user's account when deleting the user
db.Select("Account").Delete(&user)

// Delete a user's Orders and CreditCards associations when deleting the user
db.Select("Orders", "CreditCards").Delete(&user)

// Delete all of a user's has one, has many, and many2many associations
db.Select(clause.Associations).Delete(&user)

// Delete each user's account when deleting multiple users
db.Select("Account").Delete(&users)
```

需要注意的是，只有当删除记录的主键不为零时，关联才会被删除。GORM 使用这些主键作为条件来删除选定的关联。

```go
// This will not work as intended
db.Select("Account").Where("name = ?", "jinzhu").Delete(&User{})
// SQL: Deletes all users with name 'jinzhu', but their accounts won't be deleted

// Correct way to delete a user and their account
db.Select("Account").Where("name = ?", "jinzhu").Delete(&User{ID: 1})
// SQL: Deletes the user with name 'jinzhu' and ID '1', and the user's account

// Deleting a user with a specific ID and their account
db.Select("Account").Delete(&User{ID: 1})
// SQL: Deletes the user with ID '1', and the user's account
```
# 关联模式

要启动关联模式，请指定源模型和关系的字段名称。源模型必须包含主键，并且关系的字段名称应与现有关联匹配。**关联模式就是让 GORM 自动帮你处理数据表之间的关系​**​，比如用户和订单、文章和标签等关系。

```go
var user User
db.Model(&user).Association("Languages")
// Check for errors
error := db.Model(&user).Association("Languages").Error

```
## 寻找关联

检索有或无附加条件的相关记录。

```go
// Simple find
db.Model(&user).Association("Languages").Find(&languages)

// Find with conditions
codes := []string{"zh-CN", "en-US", "ja-JP"}
db.Model(&user).Where("code IN ?", codes).Association("Languages").Find(&languages)

```
# 附加关联

为 `many to many` 、 `has many` 添加新关联，或为 `has one` 、 `belongs to` 替换当前关联。

```go

```
