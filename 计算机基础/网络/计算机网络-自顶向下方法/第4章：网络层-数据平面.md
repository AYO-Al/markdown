# 1 导论

> 网络层的关键功能

- 转发：将分组从路由器的输入接口转发到合适的输出接口
- 路由：使用路由算法决定分组从发送主机到目标接收主机的路径
	- 路由选择算法
	- 路由选择协议

> 数据平面

- 本地每个路由器功能
- 决定从路由器的输入端口到达的分组如何转发到输出端口
- 转发功能：
	- 传统方式：基于目标地址+转发表
	- SDN：基于多个字段+流表

> 控制平面

- 网络范围内的逻辑
- 决定数据报如何在路由器之间路由，决定数据报从源到目标主机之间的端到端路径
- 2个控制平面方法：
	- 传统路由算法：在路由器中被实现
		- 在每一个路由器中的单独路由器算法元件在控制平面进行交互
	- SDN：在远程服务器中实现
		- 一个不同（通常是是远程的）的控制器与本地控制代理（CAs）交互

> 网络层提供的服务模型

- 对于单个数据报的服务：
	- 可靠传送
	- 延迟保证
- 对于数据报流的服务：
	- 保证数据报传送
	- 保证流的最小带宽
	- 分组之间的延迟差
# 2 路由器组成

高层面通用路由器体系架构

- 路由：运行路由选择算法（RIP/OSPF/BGP ）生成路由表
- 转发：从输入到输出链路交换数据报-根据路由表进行分组的转发

## 2.1 输入端口功能

## 2.2 输入端口缓存

## 2.3 交换结构

- 将分组从输入缓冲区传输到合适的输出端口
- 交换速率：分组可以按照该速率从输入传输到输出
	- 运行速度通常是输入/输出链路速率的若干倍
- 有三种比较典型的交换机构
	- memory
	- bus
	- crossbar

### 2.3.1 通过内存交换
### 2.3.2 通过总线方式交换

### 2.3.3 通过互联网络交换
## 2.4 输出端口

- 当数据报从交换结构来的速度比传输速率要快就需要输出端口缓存
- 由调度规则选择排队的数据报进行传输

> 调度机制

- 调度：选择下一个要通过链路的分组
- FIFO：按照分组到来的次序发送
	- 丢弃策略：如果分组到达一个满的队列，先丢弃哪个？
		- tail drop：丢弃刚到达的分组
		- priority：根据优先权丢弃分组
		- random：随机丢弃

# 3 IP协议

## 3.1 IP协议报文结构

![[第4章：网络层-数据平面_time_1.png]]

> IP的分片和分组

- 网络链路层有MTU（最大传输单元-链路层帧所携带的最大数据长度）
- 大的IP数据报在网络上被分片
	- 一个数据报被分割成若干个小的数据报
		- 相同的ID
		- 不同的偏移量
		- 最后一个分片标记为0
	- 重组只在最终的目标主机上进行
	- IP头部信息被用于标识排序相关分片

![[第4章：网络层-数据平面_time_2.png]]
## 3.2 IP地址

- IP地址：32位标识，对主机或路由器的接口编址
- 接口：主机/路由器和链路的连接处
	- 路由器通常有多个接口
	- 主机也有可能有多个接口
	- IP地址和每一个接口关联
- 一个IP地址和一个接口相关联

> 子网

- IP地址：
	- 子网部分（高位bits）
	- 主机部分（低位bits）
- 什么是子网
	- 一个子网内的节点(主机或路由器)它们的IP地址的高位部分相同，这个节点构成的网络的一部分叫做子网
	- 无需路由器介入，子网内各主机可以在物理上相互直接到达

> IP地址分类

- A类：0开头，一个字节网络位
- B类：10开头，两个字节网络位
- C类：110开头
- D类：1110开头
- A/B/C：单播地址
- D：组播地址

> 特殊IP地址

- 子网全0:本网络
- 主机全0:本主机
- 主机全1:广播地址，这个网络的所有地址
- 127开头的为回环地址

- 专用地址/私有地址：这些地址被设计用于内部网络（如家庭或公司局域网），不会在公共互联网上被路由。

| 类别           | IP地址范围                           | 子网掩码 (MASK)     |
| ------------ | -------------------------------- | --------------- |
| **Class A**​ | `10.0.0.0`- `10.255.255.255`     | `255.0.0.0`     |
| **Class B**​ | `172.16.0.0`- `172.31.255.255`   | `255.255.0.0`   |
| **Class C**​ | `192.168.0.0`- `192.168.255.255` | `255.255.255.0` |
> CIDR：Classless InterDomain Routing

无类域间路由：
- 子网部分可以在任意位置
- 地址格式：a.b.c.d/x，其中x为子网号部分长度
- 把IP和子网掩码做与运算即可获取网络位，去查路由表的表项，如果没找到则走默认表项。

> 如何获取一个地址？

- 一个ISP如何获得一块地址？
- ICANN：Internet Corporation forAssigned Name and Numbers
	- 分配地址
	- 管理DNS
	- 分配域名，解决冲突 

> 最长前缀匹配

> NAT：Network Address Translation

![[第4章：网络层-数据平面_time_3.png]]

# 4 通用转发和SDN

